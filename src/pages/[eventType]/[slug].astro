---
// src/pages/[eventType]/[slug].astro

// 1. Add this line to enable getStaticPaths in 'server' mode
export const prerender = true;

import { type CollectionEntry, getCollection } from 'astro:content';
import Layout from '@/layouts/Layout.astro';
import Countdown from '@/components/xv/Countdown.astro';
import EventLocation from '@/components/xv/EventLocation.astro';
import FooterXV from '@/components/xv/Footer.astro';
import Hero from '@/components/invitation/Hero.astro';
import FamilyXV from '@/components/xv/Family.astro';
import QuoteXV from '@/components/xv/Quote.astro';
import ThankYouXV from '@/components/xv/ThankYou.astro';
import Gifts from '@/components/invitation/Gifts.astro';
import RSVP from '@/components/invitation/RSVP';
import MusicPlayer from '@/components/invitation/MusicPlayer';
import EventHeader from '@/components/invitation/EventHeader.astro';
import EnvelopeReveal from '@/components/invitation/EnvelopeReveal';

// Placeholder for future Wedding components
// import HeroWedding from '@/components/wedding/Hero.astro';

export async function getStaticPaths() {
	const events = await getCollection('events');
	return events.map((event: CollectionEntry<'events'>) => ({
		params: {
			eventType: event.data.eventType,
			slug: event.id,
		},
		props: { event },
	}));
}

interface Props {
	event: CollectionEntry<'events'>;
}

const { event } = Astro.props;

// 2. Add a safety check (Optional, but good for debugging)
if (!event) {
	return Astro.redirect('/404');
}

const { data } = event;

const isXV = data.eventType === 'xv';
const isWedding = data.eventType === 'boda';
---

<Layout title={data.title} description={data.description || ''} hideHeader={true}>
	<style
		define:vars={{
			primaryColor: data.theme.primaryColor,
			accentColor: data.theme.accentColor || '#333',
		}}
	>
		.event-theme-wrapper {
			--color-primary: var(--primaryColor);
			--color-accent: var(--accentColor);
		}
	</style>
	<main class="event-theme-wrapper">
		{
			data.envelope && !data.envelope.disabled && (
				<EnvelopeReveal
					client:load
					name={data.hero.name}
					date={data.hero.date}
					city={data.location.city}
					sealStyle={data.envelope.sealStyle}
					microcopy={data.envelope.microcopy}
					palette={data.envelope.closedPalette}
				/>
			)
		}
		{
			isXV && (
				<>
					<EventHeader
						eventName={data.hero.name}
						theme={data.theme}
						sections={{
							rsvp: data.sections?.rsvp ?? false,
							location: true,
							gifts: data.sections?.gifts ?? false,
						}}
					/>
					<Hero
						name={data.hero.name}
						date={data.hero.date}
						venueName={data.location.venueName}
						backgroundImage={data.hero.backgroundImage}
						eventType={data.eventType}
					/>
					{
						data.quote && (
							<QuoteXV text={data.quote.text} author={data.quote.author} />
						)
					}
					{data.sections?.countdown && <Countdown eventDate={data.hero.date} />}
					{
						data.family && (
							<FamilyXV
								parents={data.family.parents}
								godparents={data.family.godparents}
								featuredImage={data.family.featuredImage}
								celebrantName={data.hero.name}
							/>
						)
					}
					<EventLocation
						ceremony={data.location.ceremony}
						reception={data.location.reception}
						indications={data.location.indications}
					/>
					{
						data.sections?.gifts && data.gifts && (
							<Gifts gifts={data.gifts} />
						)
					}
					{
						data.sections?.rsvp && data.rsvp && (
							<RSVP
								client:visible
								title={data.rsvp.title}
								guestCap={data.rsvp.guestCap}
								confirmationMessage={data.rsvp.confirmationMessage}
							/>
						)
					}
					{data.thankYou && (
						<ThankYouXV
							message={data.thankYou.message}
							closingName={data.thankYou.closingName}
							image={data.thankYou.image}
						/>
					)}
					<FooterXV />
					{data.music && (
						<MusicPlayer
							client:idle
							url={data.music.url}
							autoPlay={data.music.autoPlay}
							title={data.music.title}
						/>
					)}
				</>
			)
		}

		{
			isWedding && (
				<div class="wedding-placeholder">
					<h1>Wedding Template Under Construction</h1>
					<p>Values: {data.hero.name}</p>
				</div>
			)
		}

		{
			!isXV && !isWedding && (
				<div class="error-message">
					Unknown Event Type: {data.eventType}
				</div>
			)
		}
	</main>
</Layout>

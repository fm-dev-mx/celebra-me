---
// src/pages/[eventType]/[slug].astro

// 1. Add this line to enable getStaticPaths in 'server' mode
export const prerender = true;

import { type CollectionEntry, getCollection } from 'astro:content';
import Layout from '@/layouts/Layout.astro';
import Countdown from '@/components/invitation/Countdown.astro';
import EventLocation from '@/components/invitation/EventLocation.astro';
import Footer from '@/components/invitation/Footer.astro';
import Hero from '@/components/invitation/Hero.astro';
import Family from '@/components/invitation/Family.astro';
import Quote from '@/components/invitation/Quote.astro';
import ThankYou from '@/components/invitation/ThankYou.astro';
import Gifts from '@/components/invitation/Gifts.astro';
import RSVP from '@/components/invitation/RSVP';
import MusicPlayer from '@/components/invitation/MusicPlayer';
import EventHeader from '@/components/invitation/EventHeader.astro';
import EnvelopeReveal from '@/components/invitation/EnvelopeReveal';
import Itinerary from '@/components/invitation/Itinerary.astro';
import Gallery from '@/components/invitation/Gallery.astro';

export async function getStaticPaths() {
	const events = await getCollection('events');
	return events.map((event: CollectionEntry<'events'>) => ({
		params: {
			eventType: event.data.eventType,
			slug: event.id,
		},
		props: { event },
	}));
}

interface Props {
	event: CollectionEntry<'events'>;
}

const { event } = Astro.props;

if (!event) {
	return Astro.redirect('/404');
}

const { data } = event;

const showEnvelope = !!(data.envelope && !data.envelope.disabled);

function hexToRgb(hex: string): string {
	hex = hex.replace(/^#/, '');
	if (hex.length === 3) {
		hex = hex.split('').map((char) => char + char).join('');
	}
	const bigint = parseInt(hex, 16);
	const r = (bigint >> 16) & 255;
	const g = (bigint >> 8) & 255;
	const b = bigint & 255;
	return `${r}, ${g}, ${b}`;
}

const primaryColorRgb = hexToRgb(data.theme.primaryColor);
const accentColorRgb = hexToRgb(data.theme.accentColor || '#333333');

// Preset handle
const preset = data.theme.preset;
const themeClass = preset ? `theme-preset--${preset}` : '';

// Generic Labels
const labels: Record<string, string> = {
	xv: 'Mis XV Años',
	boda: 'Nuestra Boda',
	cumple: 'Sesenta Años',
};
const heroLabel = labels[data.eventType] || 'Invitación Especial';
---

<Layout
	title={data.title}
	description={data.description || ''}
	image={data.hero.backgroundImage.src}
	hideHeader={true}
>
	<style is:global lang="scss">
		@use '@/styles/themes/presets/_all';
	</style>
	<style
		define:vars={{
			primaryColor: data.theme.primaryColor,
			primaryColorRgb: primaryColorRgb,
			accentColor: data.theme.accentColor || '#333',
			accentColorRgb: accentColorRgb,
		}}
	>
		.event-theme-wrapper {
			--color-primary: var(--primaryColor);
			--color-primary-rgb: var(--primaryColorRgb);
			--color-accent: var(--accentColor);
			--color-accent-rgb: var(--accentColorRgb);
		}
	</style>

	<main class={`event-theme-wrapper ${themeClass} ${showEnvelope ? 'event-theme-wrapper--sealed' : ''}`}>
		{
			showEnvelope && (
				<EnvelopeReveal
					client:load
					name={data.hero.name}
					date={data.hero.date}
					city={data.location.city}
					sealStyle={data.envelope.sealStyle}
					sealIcon={data.envelope.sealIcon}
					microcopy={data.envelope.microcopy}
					documentLabel={data.envelope.documentLabel}
					stampText={data.envelope.stampText}
					stampYear={data.envelope.stampYear}
					eventSlug={event.id}
					palette={data.envelope.closedPalette}
				/>
			)
		}

		<EventHeader
			eventName={data.hero.name}
			theme={data.theme}
			links={data.navigation}
		/>

		<Hero
			name={data.hero.name}
			label={heroLabel}
			nickname={data.hero.nickname}
			date={data.hero.date}
			venueName={data.location.venueName}
			backgroundImage={data.hero.backgroundImage}
			portrait={data.hero.portrait}
		/>

		{data.quote && <Quote text={data.quote.text} author={data.quote.author} />}

		{
			data.sections?.countdown && (
				<Countdown
					eventDate={data.hero.date}
					title={data.countdown?.title}
					subtitlePrefix={data.countdown?.subtitlePrefix}
					footerText={data.countdown?.footerText}
				/>
			)
		}

		{
			data.family && (
				<Family
					parents={data.family.parents}
					godparents={data.family.godparents}
					featuredImage={data.family.featuredImage}
					celebrantName={data.hero.name}
				/>
			)
		}

		<EventLocation
			ceremony={data.location.ceremony}
			reception={data.location.reception}
			indications={data.location.indications}
		/>

		{
			data.itinerary && (
				<Itinerary title={data.itinerary.title} items={data.itinerary.items} />
			)
		}

		{data.sections?.gifts && data.gifts && <Gifts gifts={data.gifts} />}

		{
			data.sections?.gallery && data.gallery && (
				<Gallery
					title={data.gallery.title}
					subtitle={data.gallery.subtitle}
					items={data.gallery.items}
				/>
			)
		}

		{
			data.sections?.rsvp && data.rsvp && (() => {
				const rsvpProps = data.eventType === 'cumple'
					? {
							nameLabel: 'Nombre de los invitados *',
							guestCountLabel: 'Lugares reservados',
							buttonLabel: 'Confirmar lugar',
						}
					: {};

				return (
					<RSVP
						client:visible
						title={data.rsvp.title}
						guestCap={data.rsvp.guestCap}
						confirmationMessage={data.rsvp.confirmationMessage}
						{...rsvpProps}
					/>
				);
			})()
		}

		{
			data.thankYou && (
				<ThankYou
					message={data.thankYou.message}
					closingName={data.thankYou.closingName}
					image={data.thankYou.image}
				/>
			)
		}

		<Footer />

		{
			data.music && (
				<MusicPlayer
					client:idle
					url={data.music.url}
					autoPlay={data.music.autoPlay}
					title={data.music.title}
				/>
			)
		}
	</main>
</Layout>

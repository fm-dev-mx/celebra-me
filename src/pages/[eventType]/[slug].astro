---
// src/pages/[eventType]/[slug].astro

// 1. Add this line to enable getStaticPaths in 'server' mode
export const prerender = true;

import { type CollectionEntry, getCollection } from 'astro:content';
import { getEventAsset, type EventAssetKey, type ImageAsset } from '@/lib/assets/AssetRegistry';
import Layout from '@/layouts/Layout.astro';
import Countdown from '@/components/invitation/Countdown.astro';
import EventLocation from '@/components/invitation/EventLocation.astro';
import Footer from '@/components/invitation/Footer.astro';
import Hero from '@/components/invitation/Hero.astro';
import Family from '@/components/invitation/Family.astro';
import Quote from '@/components/invitation/Quote.astro';
import ThankYou from '@/components/invitation/ThankYou.astro';
import Gifts from '@/components/invitation/Gifts.astro';
import RSVP from '@/components/invitation/RSVP';
import MusicPlayer from '@/components/invitation/MusicPlayer';
import EventHeader from '@/components/invitation/EventHeader.astro';
import EnvelopeReveal from '@/components/invitation/EnvelopeReveal';
import Itinerary from '@/components/invitation/Itinerary.astro';
import Gallery from '@/components/invitation/Gallery.astro';

type Props = {
	event: CollectionEntry<'events'>;
};

export async function getStaticPaths() {
	const events = await getCollection('events');
	return events.map((event: CollectionEntry<'events'>) => ({
		params: {
			eventType: event.data.eventType,
			slug: event.id,
		},
		props: { event },
	}));
}

const { event } = Astro.props as Props;

if (!event) {
	return Astro.redirect('/404');
}

const { data } = event;

const showEnvelope = !!(data.envelope && !data.envelope.disabled);
const musicRevealMode = showEnvelope ? 'envelope' : 'immediate';

function hexToRgb(hex: string): string {
	hex = hex.replace(/^#/, '');
	if (hex.length === 3) {
		hex = hex.split('').map((char) => char + char).join('');
	}
	const bigint = parseInt(hex, 16);
	const r = (bigint >> 16) & 255;
	const g = (bigint >> 8) & 255;
	const b = bigint & 255;
	return `${r}, ${g}, ${b}`;
}

const primaryColorRgb = hexToRgb(data.theme.primaryColor);
const accentColorRgb = hexToRgb(data.theme.accentColor || '#333333');

// --- Asset Resolution Helpers ---
function resolveAsset(keyOrUrl: string | undefined): ImageAsset | undefined {
	if (!keyOrUrl) return undefined;

	// If it's a URL (cloud or external), return as ImageAsset
	if (keyOrUrl.startsWith('http') || keyOrUrl.startsWith('/')) {
		return {
			src: keyOrUrl,
			alt: 'Recurso del evento'
		};
	}

	// Otherwise treat as registry key
	return getEventAsset(event.id, keyOrUrl as EventAssetKey);
}

function requireAsset(keyOrUrl: string): ImageAsset {
	const asset = resolveAsset(keyOrUrl);
	if (!asset) {
		console.warn(`[AssetWarning] Asset not found for key: ${keyOrUrl} in event ${event.id}`);
		// Fallback to avoid crash, though this should ideally be handled better
		return { src: '', alt: 'Recurso faltante' };
	}
	return asset;
}

// --- Data Mapping ---
// Map registry keys/URLs to actual ImageAsset objects for components
const heroBg = requireAsset(data.hero.backgroundImage);
const heroPortrait = resolveAsset(data.hero.portrait);
const ceremonyData = data.location.ceremony ? {
	...data.location.ceremony,
	image: data.location.ceremony.image ? resolveAsset(data.location.ceremony.image) : undefined
} : undefined;

const receptionData = data.location.reception ? {
	...data.location.reception,
	image: data.location.reception.image ? resolveAsset(data.location.reception.image) : undefined
} : undefined;

const familyImage = data.family?.featuredImage ? resolveAsset(data.family.featuredImage) : undefined;
const thankYouImage = data.thankYou?.image ? resolveAsset(data.thankYou.image) : undefined;

// Gallery Mapping
const galleryItems = data.gallery?.items.map((item: { image: string; caption?: string }) => ({
	...item,
	image: requireAsset(item.image)
})) || [];

// Preset handle (Architecture Refactor)
const preset = data.theme.preset;
const themeClass = preset ? `theme-preset--${preset}` : '';

const heroLabel = data.hero.label || 'Invitaci√≥n Especial';
const heroImageSrc = typeof heroBg.src === 'string' ? heroBg.src : heroBg.src.src;

const envBg = data.envelope?.closedPalette?.background || 'radial-gradient(circle at center, #1b2735 0%, #090a0f 100%)';
const envPrimary = data.envelope?.closedPalette?.primary || data.theme.primaryColor;
const envAccent = data.envelope?.closedPalette?.accent || data.theme.accentColor || '#d4af37';
---

<Layout
	title={data.title}
	description={data.description || ''}
	image={heroImageSrc}
	hideHeader={true}
>

	<style
		define:vars={{
			primaryColor: data.theme.primaryColor,
			primaryColorRgb: primaryColorRgb,
			accentColor: data.theme.accentColor || '#333',
			accentColorRgb: accentColorRgb,
			envBg,
			envPrimary,
			envAccent,
		}}
	>
		.event-theme-wrapper {
			--color-primary: var(--primaryColor);
			--color-primary-rgb: var(--primaryColorRgb);
			--color-accent: var(--accentColor);
			--color-accent-rgb: var(--accentColorRgb);
			--env-bg: var(--envBg);
			--env-primary: var(--envPrimary);
			--env-accent: var(--envAccent);
		}
	</style>

	<main class={`event-theme-wrapper ${themeClass} ${showEnvelope ? 'event-theme-wrapper--sealed' : ''}`}>
		<script is:inline define:vars={{ eventSlug: event.id }}>
			const legacyToken = new URLSearchParams(window.location.search).get('t');
			if (legacyToken) {
				const params = new URLSearchParams({
					eventSlug,
					token: legacyToken,
				});
				fetch(`/api/invitacion/resolve?${params.toString()}`)
					.then((response) => (response.ok ? response.json() : null))
					.then((payload) => {
						if (payload?.canonicalUrl) {
							window.location.replace(payload.canonicalUrl);
						}
					})
					.catch(() => {
						// silent fallback to legacy token flow in current page
					});
			}
		</script>

		{/* Sync unlock: runs before React hydration to prevent pointer-events deadlock */}
		{showEnvelope && (
			<script is:inline define:vars={{ eventSlug: event.id }}>
				const key = `envelope-opened-${eventSlug}`;
				if (localStorage.getItem(key) === 'true') {
					document.body.classList.add('invitation-revealed');
				}
			</script>
		)}

		{
			data.envelope && !data.envelope.disabled && (
				<EnvelopeReveal
					client:load
					name={data.hero.name}
					date={data.hero.date}
					city={data.location.city}
					sealStyle={data.envelope.sealStyle}
					sealIcon={data.envelope.sealIcon}
					microcopy={data.envelope.microcopy}
					documentLabel={data.envelope.documentLabel}
					stampText={data.envelope.stampText}
					stampYear={data.envelope.stampYear}
					tooltipText={data.envelope.tooltipText}
					eventSlug={event.id}
					variant={preset}
				/>
			)
		}

		<EventHeader
			eventName={data.hero.name}
			theme={data.theme}
			links={data.navigation}
			variant={preset}
		/>

		<Hero
			name={data.hero.name}
			label={heroLabel}
			nickname={data.hero.nickname}
			date={data.hero.date}
			venueName={data.location.venueName}
			backgroundImage={heroBg}
			portrait={heroPortrait}
			variant={preset}
		/>

		{data.quote && (
			<Quote
				text={data.quote.text}
				author={data.quote.author}
				variant={data.sectionStyles?.quote?.variant}
				animation={data.sectionStyles?.quote?.animation}
			/>
		)}

		{
			data.family && (
				<Family
					parents={data.family.parents}
					spouse={data.family.spouse}
					children={data.family.children}
					featuredImage={familyImage}
					labels={data.family.labels}
					celebrantName={data.hero.name}
					variant={data.sectionStyles?.family?.variant}
				/>
			)
		}

		{
			data.sections?.gallery && data.gallery && (
				<Gallery
					title={data.gallery.title}
					subtitle={data.gallery.subtitle}
					items={galleryItems}
					variant={data.sectionStyles?.gallery?.variant}
				/>
			)
		}

		{
			data.sections?.countdown && (
				<Countdown
					eventDate={data.hero.date}
					title={data.countdown?.title}
					subtitlePrefix={data.countdown?.subtitlePrefix}
					footerText={data.countdown?.footerText}
					variant={data.sectionStyles?.countdown?.variant}
					showParticles={data.sectionStyles?.countdown?.showParticles}
				/>
			)
		}

		<EventLocation
			ceremony={ceremonyData}
			reception={receptionData}
			indications={data.location.indications}
			variant={data.sectionStyles?.location?.variant}
			mapStyle={data.sectionStyles?.location?.mapStyle}
			showFlourishes={data.sectionStyles?.location?.showFlourishes}
		/>

		{
			data.itinerary && (
				<Itinerary title={data.itinerary.title} items={data.itinerary.items} variant={data.sectionStyles?.itinerary?.variant ?? preset} />
			)
		}

		{
			data.sections?.rsvp && data.rsvp && (
				<RSVP
					client:visible
					eventSlug={event.id}
					title={data.rsvp.title}
					guestCap={data.rsvp.guestCap}
					confirmationMessage={data.rsvp.confirmationMessage}
					showDietaryField={data.rsvp.showDietaryField}
					dietaryLabel={data.rsvp.dietaryLabel}
					dietaryPlaceholder={data.rsvp.dietaryPlaceholder}
					confirmationMode={data.rsvp.confirmationMode}
					whatsappConfig={data.rsvp.whatsappConfig}
					variant={data.sectionStyles?.rsvp?.variant ?? preset}
					nameLabel={data.sectionStyles?.rsvp?.labels?.name ?? data.sectionStyles?.rsvp?.nameLabel}
					guestCountLabel={data.sectionStyles?.rsvp?.labels?.guestCount ?? data.sectionStyles?.rsvp?.guestCountLabel}
					attendanceLabel={data.sectionStyles?.rsvp?.labels?.attendance}
					buttonLabel={data.sectionStyles?.rsvp?.labels?.confirmButton ?? data.sectionStyles?.rsvp?.buttonLabel}
				/>
			)
		}

		{
			data.sections?.gifts && data.gifts && (
				<Gifts
					gifts={data.gifts.items}
					title={data.gifts.title}
					subtitle={data.gifts.subtitle}
					variant={data.sectionStyles?.gifts?.variant}
				/>
			)
		}

		{
			data.thankYou && (
				<ThankYou
					message={data.thankYou.message}
					closingName={data.thankYou.closingName}
					image={thankYouImage}
					variant={data.sectionStyles?.thankYou?.variant}
				/>
			)
		}

		<Footer eventSlug={event.id} showEnvelope={showEnvelope} />

		{
			data.music && (
				<MusicPlayer
					client:idle
					url={data.music.url}
					autoPlay={data.music.autoPlay}
					title={data.music.title}
					revealMode={musicRevealMode}
					variant={preset}
				/>
			)
		}
	</main>
</Layout>

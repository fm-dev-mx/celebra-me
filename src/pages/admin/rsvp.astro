---
import * as rsvpAuth from '@/lib/rsvp/adminAuth';

const defaultEventSlug = 'gerardo-sesenta';

const authHeader = Astro.request.headers.get('authorization');
if (!rsvpAuth.isAuthorizedBasicAuth(authHeader)) {
	return rsvpAuth.unauthorizedTextResponse();
}
---

<html lang="es">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Admin RSVP</title>
		<style>
			body {
				font-family: 'Montserrat', system-ui, sans-serif;
				margin: 0;
				padding: 2rem;
				background: #f5f2e9;
				color: #2b1f16;
			}
			.panel {
				max-width: 1200px;
				margin: 0 auto;
				background: #fff;
				border: 1px solid #d9c9ad;
				border-radius: 12px;
				padding: 1.25rem;
			}
			h1,
			h2 {
				margin-top: 0;
			}
			.card {
				border: 1px solid #eadfce;
				border-radius: 10px;
				padding: 1rem;
				margin-bottom: 1.2rem;
				background: #fffdf8;
			}
			.controls {
				display: grid;
				grid-template-columns: 1fr 180px 160px auto auto;
				gap: 0.75rem;
				margin-bottom: 1rem;
			}
			.invitation-controls {
				display: grid;
				grid-template-columns: 1fr auto auto auto;
				gap: 0.75rem;
				margin-bottom: 0.75rem;
			}
			input,
			select,
			button,
			a {
				font: inherit;
				padding: 0.65rem 0.75rem;
				border: 1px solid #c6b28f;
				border-radius: 8px;
				background: #fff;
				color: #2b1f16;
			}
			button {
				cursor: pointer;
				background: #3a2819;
				color: #fff;
			}
			button.secondary {
				background: #fff;
				color: #2b1f16;
			}
			a {
				text-decoration: none;
				display: inline-flex;
				align-items: center;
				justify-content: center;
			}
			.stats {
				display: flex;
				gap: 1rem;
				margin-bottom: 1rem;
			}
			table {
				width: 100%;
				border-collapse: collapse;
				font-size: 0.92rem;
			}
			th,
			td {
				border-bottom: 1px solid #eadfce;
				padding: 0.65rem 0.5rem;
				text-align: left;
				vertical-align: top;
			}
			.badge {
				padding: 0.2rem 0.5rem;
				border-radius: 999px;
				font-size: 0.78rem;
				border: 1px solid transparent;
			}
			.badge--confirmed {
				background: #e8f8ef;
				color: #146b3a;
				border-color: #b8e7c9;
			}
			.badge--declined {
				background: #feeceb;
				color: #8c2323;
				border-color: #f6c7c5;
			}
			.badge--pending {
				background: #fdf7e6;
				color: #7c6115;
				border-color: #ebdca6;
			}
			.table-actions {
				display: flex;
				flex-wrap: wrap;
				gap: 0.35rem;
			}
			.link-cell {
				max-width: 380px;
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
			}
			.panel-note {
				font-size: 0.9rem;
				color: #5d4b3a;
				margin: 0.4rem 0 0.8rem;
			}
			.status-line {
				font-size: 0.9rem;
				margin: 0.35rem 0;
			}
			.status-line--error {
				color: #8c2323;
			}
			.status-line--ok {
				color: #146b3a;
			}
			@media (max-width: 900px) {
				.controls,
				.invitation-controls {
					grid-template-columns: 1fr;
				}
				table {
					font-size: 0.85rem;
				}
				.link-cell {
					max-width: 200px;
				}
			}
		</style>
	</head>
	<body>
		<main class="panel">
			<h1>Panel RSVP</h1>

			<section class="card">
				<h2>Invitaciones</h2>
				<p class="panel-note">
					Genera links personalizados y compártelos por WhatsApp. El link genérico sirve como
					fallback.
				</p>
				<div class="invitation-controls">
					<input id="eventSlugLinks" value={defaultEventSlug} placeholder="eventSlug" />
					<button id="loadLinksBtn" type="button">Cargar links</button>
					<button id="copyGenericBtn" type="button" class="secondary">Copiar link genérico</button>
					<a id="openGenericLink" href="#" target="_blank" rel="noopener noreferrer">Abrir genérico</a>
				</div>
				<p class="status-line" id="invitationStatus"></p>
				<div style="overflow:auto">
					<table>
						<thead>
							<tr>
								<th>Invitado</th>
								<th>guestId</th>
								<th>Cupo</th>
								<th>Link personalizado</th>
								<th>Acciones</th>
							</tr>
						</thead>
						<tbody id="invitationRows"></tbody>
					</table>
				</div>
			</section>

			<section class="card">
				<h2>Registros RSVP</h2>
				<div class="controls">
					<input id="eventSlug" value={defaultEventSlug} placeholder="eventSlug" />
					<input id="search" placeholder="Buscar por nombre" />
					<select id="status">
						<option value="all">Todos</option>
						<option value="confirmed">Confirmados</option>
						<option value="declined">Declinados</option>
						<option value="pending">Pendientes</option>
					</select>
					<button id="refreshBtn" type="button">Actualizar</button>
					<a id="csvLink" href={`/api/rsvp/export.csv?eventSlug=${defaultEventSlug}`}>Exportar CSV</a>
				</div>

				<section class="stats" id="stats"></section>
				<div style="overflow:auto">
					<table>
						<thead>
							<tr>
								<th>Nombre</th>
								<th>Origen</th>
								<th>Estado</th>
								<th>Asistentes</th>
								<th>Duplicado</th>
								<th>Actualizado</th>
								<th>WhatsApp</th>
							</tr>
						</thead>
						<tbody id="rows"></tbody>
					</table>
				</div>
			</section>
		</main>

		<script is:inline>
			const eventSlugInput = document.getElementById('eventSlug');
			const eventSlugLinksInput = document.getElementById('eventSlugLinks');
			const searchInput = document.getElementById('search');
			const statusSelect = document.getElementById('status');
			const refreshBtn = document.getElementById('refreshBtn');
			const loadLinksBtn = document.getElementById('loadLinksBtn');
			const rowsEl = document.getElementById('rows');
			const statsEl = document.getElementById('stats');
			const csvLink = document.getElementById('csvLink');
			const invitationRowsEl = document.getElementById('invitationRows');
			const invitationStatusEl = document.getElementById('invitationStatus');
			const copyGenericBtn = document.getElementById('copyGenericBtn');
			const openGenericLink = document.getElementById('openGenericLink');

			let currentInvitationData = null;

			const formatDate = (iso) => {
				try {
					return new Date(iso).toLocaleString('es-MX');
				} catch {
					return iso;
				}
			};

			const setInvitationStatus = (message, type = 'ok') => {
				invitationStatusEl.textContent = message || '';
				invitationStatusEl.className = `status-line ${
					type === 'error' ? 'status-line--error' : 'status-line--ok'
				}`;
			};

			const copyText = async (text) => {
				if (!text) return false;
				if (navigator.clipboard && navigator.clipboard.writeText) {
					await navigator.clipboard.writeText(text);
					return true;
				}

				const helper = document.createElement('textarea');
				helper.value = text;
				document.body.appendChild(helper);
				helper.select();
				const ok = document.execCommand('copy');
				document.body.removeChild(helper);
				return ok;
			};

			const renderStats = (totals) => {
				statsEl.innerHTML = `
					<div><strong>Total:</strong> ${totals.total}</div>
					<div><strong>Confirmados:</strong> ${totals.confirmed}</div>
					<div><strong>Declinados:</strong> ${totals.declined}</div>
					<div><strong>Pendientes:</strong> ${totals.pending}</div>
				`;
			};

			const renderRows = (items) => {
				if (!items.length) {
					rowsEl.innerHTML = '<tr><td colspan="7">Sin registros.</td></tr>';
					return;
				}

				rowsEl.innerHTML = items
					.map((row) => {
						const action = row.lastChannelEvent?.action || '-';
						const actionAt = row.lastChannelEvent?.occurredAt;
						return `
							<tr>
								<td>${row.guestNameEntered}</td>
								<td>${row.source}</td>
								<td><span class="badge badge--${row.attendanceStatus}">${row.attendanceStatus}</span></td>
								<td>${row.attendeeCount}</td>
								<td>${row.isPotentialDuplicate ? 'Sí' : 'No'}</td>
								<td>${formatDate(row.lastUpdatedAt)}</td>
								<td>${action}${actionAt ? ` (${formatDate(actionAt)})` : ''}</td>
							</tr>
						`;
					})
					.join('');
			};

			const renderInvitationRows = (guests) => {
				if (!guests.length) {
					invitationRowsEl.innerHTML = '<tr><td colspan="5">Sin invitados configurados.</td></tr>';
					return;
				}

				invitationRowsEl.innerHTML = guests
					.map(
						(guest) => `
						<tr>
							<td>${guest.displayName}</td>
							<td>${guest.guestId}</td>
							<td>${guest.maxAllowedAttendees}</td>
							<td class="link-cell"><a href="${guest.personalizedUrl}" target="_blank" rel="noopener noreferrer">${guest.personalizedUrl}</a></td>
							<td>
								<div class="table-actions">
									<button type="button" class="secondary" data-copy-url="${guest.personalizedUrl}">Copiar</button>
									<a href="${guest.personalizedUrl}" target="_blank" rel="noopener noreferrer">Abrir</a>
									${guest.waShareUrl ? `<a href="${guest.waShareUrl}" target="_blank" rel="noopener noreferrer">WhatsApp</a>` : '<span>-</span>'}
								</div>
							</td>
						</tr>
					`,
					)
					.join('');
			};

			const loadInvitations = async () => {
				const eventSlug = eventSlugLinksInput.value.trim();
				if (!eventSlug) {
					setInvitationStatus('Escribe un eventSlug para cargar links.', 'error');
					return;
				}

				try {
					setInvitationStatus('Cargando links...');
					const params = new URLSearchParams({ eventSlug });
					const response = await fetch(`/api/rsvp/invitations?${params.toString()}`);
					const data = await response.json();
					if (!response.ok) {
						setInvitationStatus(data.message || 'No se pudieron cargar los links.', 'error');
						invitationRowsEl.innerHTML = '<tr><td colspan="5">Sin datos.</td></tr>';
						currentInvitationData = null;
						openGenericLink.href = '#';
						return;
					}

					currentInvitationData = data;
					renderInvitationRows(data.guests || []);
					openGenericLink.href = data.genericUrl || '#';
					const baseMessage = data.message || `Links listos para ${data.eventSlug}.`;
					setInvitationStatus(baseMessage, 'ok');
				} catch {
					setInvitationStatus('Error al cargar links de invitación.', 'error');
				}
			};

			const loadData = async () => {
				const eventSlug = eventSlugInput.value.trim();
				const search = searchInput.value.trim();
				const status = statusSelect.value;
				csvLink.href = `/api/rsvp/export.csv?eventSlug=${encodeURIComponent(eventSlug)}`;

				if (!eventSlug) return;

				const params = new URLSearchParams({
					eventSlug,
					status,
					search,
				});

				const response = await fetch(`/api/rsvp/admin?${params.toString()}`);
				const data = await response.json();
				renderStats(data.totals || { total: 0, confirmed: 0, declined: 0, pending: 0 });
				renderRows(data.items || []);
			};

			invitationRowsEl.addEventListener('click', async (event) => {
				const target = event.target;
				if (!(target instanceof HTMLElement)) return;
				const copyUrl = target.getAttribute('data-copy-url');
				if (!copyUrl) return;

				event.preventDefault();
				try {
					const copied = await copyText(copyUrl);
					setInvitationStatus(copied ? 'Link personalizado copiado.' : 'No se pudo copiar.', copied ? 'ok' : 'error');
				} catch {
					setInvitationStatus('No se pudo copiar el link.', 'error');
				}
			});

			copyGenericBtn.addEventListener('click', async () => {
				const genericUrl = currentInvitationData?.genericUrl;
				if (!genericUrl) {
					setInvitationStatus('Primero carga links para copiar el genérico.', 'error');
					return;
				}

				try {
					const copied = await copyText(genericUrl);
					setInvitationStatus(copied ? 'Link genérico copiado.' : 'No se pudo copiar.', copied ? 'ok' : 'error');
				} catch {
					setInvitationStatus('No se pudo copiar el link genérico.', 'error');
				}
			});

			loadLinksBtn.addEventListener('click', loadInvitations);
			refreshBtn.addEventListener('click', loadData);
			statusSelect.addEventListener('change', loadData);

			loadInvitations();
			loadData();
		</script>
	</body>
</html>

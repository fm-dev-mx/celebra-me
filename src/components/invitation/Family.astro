---
// src/components/invitation/Family.astro
import '@/styles/invitation/_family.scss';
import Container from '@/components/layout/Container.astro';
import OptimizedImage from '@/components/common/OptimizedImage.astro';
import FamilyDecorations from './FamilyDecorations.astro';
import type { ImageAsset } from '@/lib/assets/AssetRegistry';

interface Props {
	parents?: {
		father?: string;
		mother?: string;
	};
	spouse?: string;
	children?: Array<{
		name: string;
		role?: string;
	}>;
	featuredImage?: string | ImageAsset;
	celebrantName: string;
	labels?: {
		sectionTitle?: string;
		sectionSubtitle?: string;
		spouseTitle?: string;
		spouseRole?: string;
		childrenTitle?: string;
		parentsTitle?: string;
	};
	variant?: string;
}

interface FamilyEntry {
	name?: string;
	role?: string;
	connector?: boolean;
	lead?: boolean;
}

interface FamilyBlock {
	id: 'spouse' | 'children' | 'parents';
	title: string;
	entries: FamilyEntry[];
	isChildren?: boolean;
}

const {
	parents,
	spouse,
	children,
	featuredImage,
	celebrantName,
	labels,
	variant = 'standard',
} = Astro.props;

const resolvedLabels = {
	sectionTitle: labels?.sectionTitle ?? 'Los que hacen mi vida completa',
	sectionSubtitle: labels?.sectionSubtitle ?? 'Mi Familia',
	spouseTitle: labels?.spouseTitle ?? 'Mi Compañera de Vida',
	spouseRole: labels?.spouseRole ?? 'Esposa',
	childrenTitle: labels?.childrenTitle ?? 'Nuestros Hijos',
	parentsTitle: labels?.parentsTitle ?? 'Con la bendición de',
};

const imagePath = featuredImage ? (typeof featuredImage === 'string' ? featuredImage : (featuredImage.src as string)) : undefined;

const familyBlocks: FamilyBlock[] = [];

if (spouse) {
	familyBlocks.push({
		id: 'spouse',
		title: resolvedLabels.spouseTitle,
		entries: [
			{
				name: spouse,
				role: resolvedLabels.spouseRole,
				lead: true,
			},
		],
	});
}

if (children && children.length > 0) {
	familyBlocks.push({
		id: 'children',
		title: resolvedLabels.childrenTitle,
		isChildren: true,
		entries: children.map((child) => ({
			name: child.name,
			role: child.role,
		})),
	});
}

if (parents && (parents.father || parents.mother)) {
	const parentEntries: FamilyEntry[] = [];

	if (parents.mother) {
		parentEntries.push({ name: parents.mother, role: 'Madre' });
	}
	if (parents.mother && parents.father) {
		parentEntries.push({ connector: true });
	}
	if (parents.father) {
		parentEntries.push({ name: parents.father, role: 'Padre' });
	}

	familyBlocks.push({
		id: 'parents',
		title: resolvedLabels.parentsTitle,
		entries: parentEntries,
	});
}
---

<section id="family-section" class="family" data-variant={variant}>
	<div class="family__bg-texture" aria-hidden="true"></div>
	<FamilyDecorations variant={variant} component="bg" />

	<Container class="family__container">
		<header class="family__header family__reveal">
			<div class="family__header-inner">
				<span class="family__eyebrow">{resolvedLabels.sectionSubtitle}</span>
				<h2 class="family__title">{resolvedLabels.sectionTitle}</h2>
				<div class="family__header-divider" aria-hidden="true"></div>
			</div>
		</header>

		<div class:list={['family__panel', !featuredImage && 'family__panel--no-media']}>
			{featuredImage && (
				<figure class="family__media family__reveal">
					<div class="family__media-frame">
						<OptimizedImage imagePath={imagePath} alt={celebrantName} width={600} height={800} />
						<FamilyDecorations variant={variant} component="frame" />
					</div>
				</figure>
			)}

			<div class="family__content">
				{familyBlocks.map((block) => (
					<section class={`family__group family__group--${block.id} family__reveal`}>
						<h3 class="family__group-title">{block.title}</h3>
						<ul class:list={['family__list', block.isChildren && 'family__list--children']}>
							{block.entries.map((entry) =>
								entry.connector ? (
									<li class="family__connector" aria-hidden="true">
										<span>y</span>
									</li>
								) : (
									<li class:list={['family__item', entry.lead && 'family__item--lead']}>
										<p class="family__name">{entry.name}</p>
										{entry.role && <span class="family__meta">{entry.role}</span>}
									</li>
								),
							)}
						</ul>
					</section>
				))}
			</div>
		</div>
	</Container>
</section>

<script>
	import { createIntersectionObserver } from '@/lib/utils/animations';

	const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

	if (!prefersReducedMotion) {
		document.querySelectorAll('.family').forEach((section) => {
			section.classList.add('has-motion');
		});

		createIntersectionObserver('.family.has-motion', (target) => {
			target.classList.add('is-visible');
		});
	}
</script>


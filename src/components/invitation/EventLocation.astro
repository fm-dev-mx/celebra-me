---
/*
  EventLocation Component
  Displays modern, interactive cards for the event venues.
*/
import '@/styles/invitation/_event-location.scss';
import '@/styles/invitation/_section-nav-button.scss';
import '@/styles/themes/sections/_location-theme.scss';
import VenueCard from '@/components/invitation/components/VenueCard.astro';
import Icon from '@/components/common/icons/Icon.astro';
import SectionNavButton from '@/components/invitation/components/SectionNavButton.astro';

import type { ImageMetadata } from 'astro';
import type { ImageAsset } from '@/lib/assets/AssetRegistry';

interface VenueData {
	venueEvent: string;
	venueName: string;
	address: string;
	date: string;
	time: string;
	mapUrl?: string;
	appleMapsUrl?: string;
	googleMapsUrl?: string;
	wazeUrl?: string;
	image?: string | ImageMetadata | ImageAsset;
	coordinates?: {
		lat: number;
		lng: number;
	};
}


interface Indication {
	icon: 'crown' | 'envelope' | 'forbidden' | 'dress' | 'western-hat' | 'gift';
	text: string;
}

interface Props {
	ceremony?: VenueData;
	reception?: VenueData;
	indications?: Indication[];
	variant?: 'structured' | 'organic' | 'minimal' | 'luxury' | 'jewelry-box' | 'luxury-hacienda';
	mapStyle?: 'dark' | 'colorful' | 'minimal' | 'satellite';
	showFlourishes?: boolean;
}

const {
	ceremony,
	reception,
	indications,
	variant = 'structured',
	mapStyle = 'dark',
	showFlourishes = true
} = Astro.props;

const isSingleVenue = (ceremony && !reception) || (!ceremony && reception);

type EventLocationIconName = 'Crown' | 'Envelope' | 'Forbidden' | 'Gift' | 'western-hat';

// Keep this map aligned with the icon registry in Icon.astro
const iconMap: Record<Indication['icon'], EventLocationIconName> = {
	crown: 'Crown',
	envelope: 'Envelope',
	forbidden: 'Forbidden',
	// There is no dedicated "Dress" icon in the current registry; use western hat as closest theme-safe fallback.
	dress: 'western-hat',
	'western-hat': 'western-hat',
	gift: 'Gift',
};

const resolveIndicationIconName = (icon: string): EventLocationIconName => {
	const mapped = iconMap[icon as Indication['icon']];
	if (mapped) return mapped;

	if (import.meta.env.DEV) {
		console.warn(`[EventLocation] Unknown indication icon "${icon}". Falling back to "Gift".`);
	}

	return 'Gift';
};
---

<section class="event-location" id="event-location" data-variant={variant} data-map-style={mapStyle} data-show-flourishes={showFlourishes}>
	<div class={`event-location__container ${isSingleVenue ? 'event-location__container--single' : ''}`}>
		{ceremony && <VenueCard venue={ceremony} type="ceremony" variant={variant} />}
		{reception && <VenueCard venue={reception} type="reception" variant={variant} />}
	</div>

	{indications && indications.length > 0 && (
		<div class="event-location__indications-container">
			<div class="event-location__divider" aria-hidden="true"></div>

			<div class="event-location__indications">
				{indications.map((indication) => {
					const isReserved = indication.text.toLowerCase().includes('púrpura');
					return (
						<div class={`event-location__indication-item ${isReserved ? 'event-location__indication-item--reserved' : ''}`}>
							<div class="event-location__indication-icon">
								<Icon name={resolveIndicationIconName(indication.icon)} size={24} />
							</div>
							<p class="event-location__indication-text" set:html={indication.text} />
						</div>
					);
				})}
			</div>
		</div>
	)}

	<div class="nav-button-container">
		<SectionNavButton href="#rsvp" class="event-location" section="Pases y Confirmación" />
	</div>

</section>

<script>
	import { initCopyButtons, revealIOSOnly } from '@/lib/utils/ui';
	import { createIntersectionObserver } from '@/lib/utils/animations';

	// Initialize UI behaviors
	initCopyButtons();
	revealIOSOnly();

	// Animations: Trigger card animations on scroll
	createIntersectionObserver('.event-location__card', (target) => {
		target.classList.add('is-visible');
	});
</script>

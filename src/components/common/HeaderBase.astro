---
/**
 * src/components/common/HeaderBase.astro
 *
 * Foundation component for all headers (Landing & Invitation).
 * Handles:
 * - Scroll detection (Shrink effect, Glassmorphism transparency)
 * - Mobile Menu state & animations
 * - Auto-Hide on landscape mobile
 */

import '@styles/layout/_header-base.scss';

export interface Props {
    transparentOnHero?: boolean;
    headerId?: string;
    logoVariant?: 'adaptive' | 'static';
    hideMobileToggle?: boolean;
    variant?: string;
}

const {
    transparentOnHero = true,
    headerId = 'main-header',
    logoVariant = 'adaptive',
    hideMobileToggle = false,
    variant = 'standard',
} = Astro.props;
---

<header
    id={headerId}
    class={`header-base ${transparentOnHero ? 'header-base--transparent' : ''} ${
        logoVariant === 'static' ? 'header-base--logo-static' : 'header-base--logo-adaptive'
    }`}
    data-variant={variant}
>
    <div class="header-base__container">
        <!-- Slot: Logo (Adaptive logic lives in parent) -->
        <div class="header-base__logo">
            <slot name="logo" />
        </div>

        <!-- Slot: Desktop Navigation -->
        <nav class="header-base__desktop-nav" aria-label="Navegacion principal">
            <slot name="desktop-nav" />
        </nav>

        <!-- Mobile Menu Toggle -->
        {!hideMobileToggle && (
            <button
                id={`${headerId}-toggle`}
                class="header-base__mobile-toggle"
                type="button"
                aria-label="Alternar navegacion"
                aria-controls={`${headerId}-overlay`}
                aria-expanded="false"
            >
                <div class="hamburger">
                    <span class="hamburger__line"></span>
                    <span class="hamburger__line"></span>
                    <span class="hamburger__line"></span>
                </div>
            </button>
        )}

        <!-- Slot for Premium Mobile Nav (React/etc) -->
        <slot name="mobile-nav-premium" />
    </div>

    <!-- Mobile Overlay -->
    {!hideMobileToggle && (
        <div id={`${headerId}-overlay`} class="header-base__mobile-overlay" aria-hidden="true">
            <nav class="header-base__mobile-menu" aria-label="Navegacion movil">
                <slot name="mobile-nav-content" />
            </nav>
        </div>
    )}
</header>

<script is:inline define:vars={{ headerId, transparentOnHero }}>
    document.addEventListener('DOMContentLoaded', () => {
        const header = document.getElementById(headerId);
        if (!(header instanceof HTMLElement)) return;

        let lastScrollY = window.scrollY;
        const isMenuOpen = false; // Handled primarily by React component or external classes now
        let allowAutoHide = false;
        const SCROLL_THRESHOLD = 50;
        const HIDE_THRESHOLD = 100;

        const updateAutoHide = () => {
            // Enable auto-hide for all devices to maximize screen real estate
            // and provide a more immersive experience (Headroom pattern)
            allowAutoHide = true;

            if (!allowAutoHide) {
                header.classList.remove('header-base--hidden');
            }
        };

        const setScrolledState = (isScrolledPastHero) => {
            header.classList.toggle('header-base--scrolled', isScrolledPastHero);

            const isMenuOpenNow = header.classList.contains('header-base--menu-open');

            if (transparentOnHero && !isMenuOpenNow) {
                header.classList.toggle('header-base--transparent', !isScrolledPastHero);
            } else {
                header.classList.remove('header-base--transparent');
            }
        };

        const handleScroll = () => {
            const currentScrollY = window.scrollY;
            const isScrolledPastHero = currentScrollY > SCROLL_THRESHOLD;

            // 1. Transparency / Glassmorphism
            setScrolledState(isScrolledPastHero);

            // 2. Auto-Hide logic
            // If menu is open (externally controlled or via class), don't do hide logic
            const isExternallyMenuOpen = header.classList.contains('header-base--menu-open');
            if (isMenuOpen || isExternallyMenuOpen) {
                header.classList.remove('header-base--hidden');
                lastScrollY = currentScrollY;
                return;
            }

            const isScrollingDown = currentScrollY > lastScrollY;

            if (allowAutoHide && currentScrollY > HIDE_THRESHOLD && isScrollingDown) {
                header.classList.add('header-base--hidden');
            } else {
                header.classList.remove('header-base--hidden');
            }

            lastScrollY = currentScrollY;
        };

        // --- DEPRECATED/CLEANUP: The mobile menu is now handled by NavBarMobile.tsx (React) ---
        // We keep isMenuOpen logic for backward compatibility or if no React component is used,
        // but we prioritize checking for the global class 'header-base--menu-open'

        // Throttle scroll event for performance
        let ticking = false;
        window.addEventListener('scroll', () => {
            if (!ticking) {
                window.requestAnimationFrame(() => {
                    handleScroll();
                    ticking = false;
                });
                ticking = true;
            }
        });

        updateAutoHide();
        handleScroll();
    });
</script>

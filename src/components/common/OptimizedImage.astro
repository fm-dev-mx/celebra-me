---
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';
import type { ImageAsset } from '@/lib/assets/AssetRegistry';

interface Props {
	imagePath: ImageMetadata | string | ImageAsset | null | undefined;
	alt: string;
	rounded?: string;
	width?: number;
	height?: number;
	class?: string;
}

const { imagePath, alt, rounded = '', width = 350, height = 350, class: className } = Astro.props;

const resolveSrc = (input: ImageMetadata | string | ImageAsset | null | undefined) => {
	if (!input) return null;
	if (typeof input === 'object' && 'src' in input && !('width' in input)) {
		// It's an ImageAsset (has src but not width/height like ImageMetadata)
		// actually ImageMetadata has src, width, height, format.
		// ImageAsset has src (string|Metadata), alt.
		return (input as ImageAsset).src;
	}
	return input;
};

const finalSrc = resolveSrc(imagePath);
---

{
	finalSrc ? (
		typeof finalSrc === 'string' ? (
			<Image
				src={finalSrc}
				alt={alt}
				width={width}
				height={height}
				class:list={[rounded, className]}
			/>
		) : (
			<Image
				src={finalSrc as ImageMetadata}
				alt={alt}
				width={width}
				height={height}
				class:list={[rounded, className]}
			/>
		)
	) : (
		<div
			class:list={['bg-gray-300 flex items-center justify-center', rounded, className]}
		>
			<span class="text-xs text-gray-500">{alt}</span>
		</div>
	)
}

<style define:vars={{ width: `${width}px`, height: `${height}px` }}>
	div {
		width: var(--width);
		height: var(--height);
	}
</style>
